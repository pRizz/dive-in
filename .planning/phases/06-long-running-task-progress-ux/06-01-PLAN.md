---
phase: 06-long-running-task-progress-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - vm/main.go
  - ui/src/App.tsx
  - ui/src/models.ts
autonomous: true
must_haves:
  truths:
    - "User sees detailed progress messages during analysis (e.g., 'Pulling image', 'Analyzing layers', 'Calculating metrics')."
    - "Analysis progress updates in real-time without blocking the UI."
    - "User can see what stage the analysis is at without guessing."
  artifacts:
    - path: "vm/main.go"
      provides: "Progress capture from Dive CLI stderr/stdout and job message updates"
    - path: "ui/src/App.tsx"
      provides: "Enhanced progress display with detailed messages"
    - path: "ui/src/models.ts"
      provides: "Updated status response types with progress details"
  key_links:
    - from: "vm/main.go"
      to: "dive CLI"
      via: "exec.CommandContext with stderr/stdout capture"
      pattern: "cmd.StderrPipe|cmd.StdoutPipe"
    - from: "ui/src/App.tsx"
      to: "vm/main.go"
      via: "Polling /analysis/:id/status for progress messages"
      pattern: "/analysis/.*/status"
---

<objective>
Capture Dive CLI progress output and enhance UI progress indicators to show detailed analysis stages.

Purpose: Users currently see only "running" status during long analyses. By capturing Dive's stderr/stdout progress output and parsing analysis stages, users will see informative progress messages like "Pulling image", "Analyzing layers", "Calculating metrics" instead of generic "running" status.

Output: Backend captures and parses Dive progress output, updates job messages with stage information, and UI displays detailed progress messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-reliable-analysis-runs/02-01-SUMMARY.md
@vm/main.go
@ui/src/App.tsx
@ui/src/models.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Capture Dive CLI progress output and update job messages</name>
  <files>vm/main.go</files>
  <action>
    - Modify `runDive` function to capture stderr and stdout separately using `cmd.StderrPipe()` and `cmd.StdoutPipe()` instead of `cmd.CombinedOutput()`.
    - Start the command and read stderr/stdout in a goroutine, parsing output for progress indicators (e.g., "Fetching image", "Analyzing", "Calculating").
    - Update job message via `jobStore.Update` with parsed progress stages as they occur (e.g., "Pulling image...", "Analyzing layers...", "Calculating metrics...").
    - Handle both progress output (stderr) and final JSON result (stdout or file) appropriately.
    - Ensure progress updates don't interfere with final result capture or error handling.
    - Keep existing timeout and error handling logic intact.
    - Progress parsing should be resilient to Dive output format variations (use string matching for common patterns like "Fetching", "Analyzing", "Calculating").
  </action>
  <verify>go test ./... && manually test analysis to verify progress messages appear in job status</verify>
  <done>Backend captures Dive CLI progress output and updates job messages with analysis stages in real-time.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance UI progress indicators with detailed messages</name>
  <files>ui/src/App.tsx, ui/src/models.ts</files>
  <action>
    - Update `AnalysisStatusResponse` type in `ui/src/models.ts` to ensure `message` field is properly typed (should already exist, verify).
    - Enhance progress display in `ImageCard` component to show detailed progress messages from `jobMessage` when available, not just status text.
    - Update the status display section (around line 174-180) to show `jobMessage` prominently when job is running, with fallback to status if message is empty.
    - Improve progress indicator UX: show progress message above LinearProgress bar, use Typography with appropriate variant (body2 or caption) for progress text.
    - Ensure progress messages update in real-time as polling receives new job status updates.
    - Keep existing spinner and LinearProgress components but enhance with detailed message display.
  </action>
  <verify>npm --prefix ui run build && manually test analysis to verify detailed progress messages appear in UI</verify>
  <done>UI displays detailed progress messages (e.g., "Pulling image...", "Analyzing layers...") during analysis instead of generic "running" status.</done>
</task>

</tasks>

<verification>
- `go test ./...` succeeds with progress capture changes.
- `npm --prefix ui run build` succeeds with enhanced progress display.
- Manual test: Start analysis and verify progress messages appear in UI during analysis.
</verification>

<success_criteria>
- Dive CLI progress output is captured and parsed into stage messages.
- Job status endpoint returns detailed progress messages during analysis.
- UI displays detailed progress messages in real-time during analysis.
- Analysis remains non-blocking (async job model unchanged).
</success_criteria>

<output>
After completion, create `.planning/phases/06-long-running-task-progress-ux/06-01-SUMMARY.md`
</output>
